AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Catalogo AWS - Complete Serverless Infrastructure
  Backend Lambda + API Gateway + DynamoDB + S3 + Cognito
  Fault-tolerant with retry logic, DLQ, and monitoring

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: nodejs20.x
    Architectures:
      - x86_64
    Environment:
      Variables:
        NODE_ENV: production
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
        PRODUCTS_TABLE: !Ref ProductsTable
        IMAGES_BUCKET: !Ref ImagesBucket
        CATEGORIES_TABLE: !Ref CategoriesTable
    Tracing: Active
    DeadLetterQueue:
      Type: SQS
      TargetArn: !GetAtt LambdaDeadLetterQueue.Arn
  Api:
    Auth:
      DefaultAuthorizer: CognitoAuthorizer
      AddDefaultAuthorizerToCorsPreflight: false
      Authorizers:
        CognitoAuthorizer:
          UserPoolArn: !GetAtt CognitoUserPool.Arn

Parameters:
  Environment:
    Type: String
    Default: production
    AllowedValues:
      - development
      - staging
      - production
    Description: Environment name
  AdminEmail:
    Type: String
    Description: Email address for the admin user
    Default: admin@example.com

Resources:
  #############################################################################
  # DYNAMODB TABLES
  #############################################################################
  ProductsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-Products'
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      AttributeDefinitions:
        - AttributeName: productId
          AttributeType: S
        - AttributeName: codice
          AttributeType: S
        - AttributeName: categoriaIt
          AttributeType: S
      KeySchema:
        - AttributeName: productId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CodiceIndex
          KeySchema:
            - AttributeName: codice
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: CategoryIndex
          KeySchema:
            - AttributeName: categoriaIt
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: Catalogo

  CategoriesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-Categories'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: categoryName
          AttributeType: S
        - AttributeName: itemName
          AttributeType: S
      KeySchema:
        - AttributeName: categoryName
          KeyType: HASH
        - AttributeName: itemName
          KeyType: RANGE
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: Catalogo

  #############################################################################
  # S3 BUCKETS
  #############################################################################
  ImagesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-images-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - '*'
            AllowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
              - HEAD
            AllowedHeaders:
              - '*'
            MaxAge: 3600
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: Catalogo

  ImagesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ImagesBucket
      PolicyDocument:
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Sub '${ImagesBucket.Arn}/*'

  #############################################################################
  # CLOUDFRONT CDN (for S3 images)
  #############################################################################
  ImagesCloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub 'CDN for ${AWS::StackName} product images'
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          Compress: true
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt ImagesBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ''
        PriceClass: PriceClass_100
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

  #############################################################################
  # COGNITO USER POOL
  #############################################################################
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${AWS::StackName}-AdminPool'
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      UsernameConfiguration:
        CaseSensitive: false
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
      MfaConfiguration: OPTIONAL
      EnabledMfas:
        - SOFTWARE_TOKEN_MFA
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      UserAttributeUpdateSettings:
        AttributesRequireVerificationBeforeUpdate:
          - email
      UserPoolTags:
        Environment: !Ref Environment

  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub '${AWS::StackName}-AdminClient'
      UserPoolId: !Ref CognitoUserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH
      PreventUserExistenceErrors: ENABLED
      RefreshTokenValidity: 30
      AccessTokenValidity: 60
      IdTokenValidity: 60
      TokenValidityUnits:
        RefreshToken: days
        AccessToken: minutes
        IdToken: minutes

  #############################################################################
  # SQS DEAD LETTER QUEUE
  #############################################################################
  LambdaDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-Lambda-DLQ'
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Environment
          Value: !Ref Environment

  #############################################################################
  # API GATEWAY
  #############################################################################
  CatalogoApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub '${AWS::StackName}-API'
      StageName: !Ref Environment
      TracingEnabled: true
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
        MaxAge: "'600'"

  #############################################################################
  # LAMBDA FUNCTIONS - PUBLIC (No Auth)
  #############################################################################
  GetProductsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-GetProducts'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getProducts.handler
      Description: Get all products (public)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetProducts:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/public/catalogo/prodotti
            Method: GET
            Auth:
              Authorizer: NONE

  GetProductByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-GetProductById'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getProductById.handler
      Description: Get product by ID (public)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetProductById:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/public/catalogo/prodotti/{productId}
            Method: GET
            Auth:
              Authorizer: NONE

  GetCategoriesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-GetCategories'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getCategories.handler
      Description: Get all categories (public)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
      Events:
        GetCategories:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/public/catalogo/categorie
            Method: GET
            Auth:
              Authorizer: NONE

  GetCategoryByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-GetCategoryById'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getCategoryById.handler
      Description: Get a single category by its ID (public)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
      Events:
        GetCategoryById:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/public/catalogo/categorie/{categoryId}
            Method: GET
            Auth:
              Authorizer: NONE
  
  GetAllSubcategoriesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-GetAllSubcategories'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getAllSubcategories.handler
      Description: Get all unique subcategories (public)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
      Events:
        GetAllSubcategories:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/public/catalogo/sottocategorie
            Method: GET
            Auth:
              Authorizer: NONE

  GetProductsByCategoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-GetProductsByCategory'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getProductsByCategory.handler
      Description: Get products by category/subcategory (public)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
      Events:
        GetByCategory:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/public/catalogo/categoria/{categoria}
            Method: GET
            Auth:
              Authorizer: NONE
        GetByCategoryAndSubcategory:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/public/catalogo/categoria/{categoria}/sottocategoria/{sottocategoria}
            Method: GET
            Auth:
              Authorizer: NONE
        GetSubcategories:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/public/catalogo/categoria/{categoria}/sottocategorie
            Method: GET
            Auth:
              Authorizer: NONE

  #############################################################################
  # LAMBDA FUNCTIONS - ADMIN (Product Management)
  #############################################################################
  CreateProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-CreateProduct'
      CodeUri: backend-lambda/
      Handler: src/handlers/admin/createProduct.handler
      Description: Create new product (admin only)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
      Events:
        CreateProduct:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/prodotti
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-UpdateProduct'
      CodeUri: backend-lambda/
      Handler: src/handlers/admin/updateProduct.handler
      Description: Update product (admin only)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
      Events:
        UpdateProduct:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/prodotti/{productId}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-DeleteProduct'
      CodeUri: backend-lambda/
      Handler: src/handlers/admin/deleteProduct.handler
      Description: Delete product (admin only)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
        - S3CrudPolicy:
            BucketName: !Ref ImagesBucket
      Events:
        DeleteProduct:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/prodotti/{productId}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

  GetPresignedUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-GetPresignedUrl'
      CodeUri: backend-lambda/
      Handler: src/handlers/upload/getPresignedUrl.handler
      Description: Generate presigned URL for image upload (admin only)
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref ImagesBucket
      Events:
        GetPresignedUrl:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/upload/presigned-url
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  AdminGetProductsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-AdminGetProducts'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getProducts.handler
      Description: Get all products (admin only)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetProducts:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/prodotti
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  AdminGetProductByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-AdminGetProductById'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getProductById.handler
      Description: Get product by ID (admin only)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetProductById:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/prodotti/{productId}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  #############################################################################
  # LAMBDA FUNCTIONS - ADMIN (Category Management) - FIXED PATHS
  #############################################################################
  AdminGetCategoriesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-AdminGetCategories'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getCategories.handler
      Description: Get all categories (admin only)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
      Events:
        GetCategories:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/categorie
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  AdminGetSubcategoriesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-AdminGetSubcategories'
      CodeUri: backend-lambda/
      Handler: src/handlers/public/getProductsByCategory.handler
      Description: Get subcategories for a category (admin only)
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
      Events:
        GetSubcategories:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/categorie/{categoria}/sottocategorie
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  CreateCategoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-CreateCategory'
      CodeUri: backend-lambda/
      Handler: src/handlers/admin/createCategory.handler
      Description: Create a new category (admin only)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
      Events:
        CreateCategory:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/categorie
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateCategoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-UpdateCategory'
      CodeUri: backend-lambda/
      Handler: src/handlers/admin/updateCategory.handler
      Description: Update a category's translations (admin only)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
      Events:
        UpdateCategory:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/categorie/{categoria}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteCategoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-DeleteCategory'
      CodeUri: backend-lambda/
      Handler: src/handlers/admin/deleteCategory.handler
      Description: Delete a category and all its subcategories (admin only)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
      Events:
        DeleteCategory:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/categorie/{categoria}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

  AddSubcategoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-AddSubcategory'
      CodeUri: backend-lambda/
      Handler: src/handlers/admin/addSubcategory.handler
      Description: Add a subcategory to a category (admin only)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
      Events:
        AddSubcategory:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/categorie/{categoria}/sottocategorie
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateSubcategoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-UpdateSubcategory'
      CodeUri: backend-lambda/
      Handler: src/handlers/admin/updateSubcategory.handler
      Description: Update a subcategory name (admin only)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
      Events:
        UpdateSubcategory:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/categorie/{categoria}/sottocategorie/{sottocategoria}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteSubcategoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-DeleteSubcategory'
      CodeUri: backend-lambda/
      Handler: src/handlers/admin/deleteSubcategory.handler
      Description: Delete a subcategory from a category (admin only)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
      Events:
        DeleteSubcategory:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /api/admin/categorie/{categoria}/sottocategorie/{sottocategoria}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

  #############################################################################
  # CATCH-ALL FUNCTION (for proper 404 responses)
  #############################################################################
  CatchAllFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-CatchAll'
      CodeUri: backend-lambda/
      Handler: src/handlers/catchAll.handler
      Description: Catch-all for undefined routes (returns 404)
      Events:
        CatchAll:
          Type: Api
          Properties:
            RestApiId: !Ref CatalogoApi
            Path: /{proxy+}
            Method: ANY
            Auth:
              Authorizer: NONE

  #############################################################################
  # CLOUDWATCH ALARMS
  #############################################################################
  ApiGateway4xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-API-4xx-Errors'
      AlarmDescription: Alert when API Gateway 4xx errors exceed threshold
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 50
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Sub '${AWS::StackName}-API'

  ApiGateway5xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-API-5xx-Errors'
      AlarmDescription: Alert when API Gateway 5xx errors exceed threshold
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Sub '${AWS::StackName}-API'

  DynamoDBThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-DynamoDB-Throttle'
      AlarmDescription: Alert when DynamoDB throttles requests
      MetricName: UserErrors
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref ProductsTable

#############################################################################
# OUTPUTS
#############################################################################
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${CatalogoApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-ApiEndpoint'

  PublicApiBaseUrl:
    Description: Public API base URL (for frontend-catalogo-utente)
    Value: !Sub 'https://${CatalogoApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/api/public/catalogo'
    Export:
      Name: !Sub '${AWS::StackName}-PublicApiBaseUrl'

  AdminApiBaseUrl:
    Description: Admin API base URL (for frontend-catalogo-admin)
    Value: !Sub 'https://${CatalogoApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/api/admin'
    Export:
      Name: !Sub '${AWS::StackName}-AdminApiBaseUrl'

  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref CognitoUserPool
    Export:
      Name: !Sub '${AWS::StackName}-CognitoUserPoolId'

  CognitoUserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref CognitoUserPoolClient
    Export:
      Name: !Sub '${AWS::StackName}-CognitoUserPoolClientId'

  CognitoUserPoolArn:
    Description: Cognito User Pool ARN
    Value: !GetAtt CognitoUserPool.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CognitoUserPoolArn'

  ProductsTableName:
    Description: DynamoDB Products Table Name
    Value: !Ref ProductsTable
    Export:
      Name: !Sub '${AWS::StackName}-ProductsTableName'

  CategoriesTableName:
    Description: DynamoDB Categories Table Name
    Value: !Ref CategoriesTable
    Export:
      Name: !Sub '${AWS::StackName}-CategoriesTableName'

  ImagesBucketName:
    Description: S3 Images Bucket Name
    Value: !Ref ImagesBucket
    Export:
      Name: !Sub '${AWS::StackName}-ImagesBucketName'

  ImagesBucketUrl:
    Description: S3 Images Bucket URL
    Value: !GetAtt ImagesBucket.WebsiteURL
    Export:
      Name: !Sub '${AWS::StackName}-ImagesBucketUrl'

  CloudFrontDistributionDomain:
    Description: CloudFront distribution domain for images
    Value: !GetAtt ImagesCloudFrontDistribution.DomainName
    Export:
      Name: !Sub '${AWS::StackName}-CloudFrontDomain'

  DeadLetterQueueUrl:
    Description: SQS Dead Letter Queue URL
    Value: !Ref LambdaDeadLetterQueue
    Export:
      Name: !Sub '${AWS::StackName}-DLQUrl'

  Region:
    Description: AWS Region
    Value: !Ref AWS::Region
    Export:
      Name: !Sub '${AWS::StackName}-Region'